// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

// Enum untuk Role
enum Role {
  USER
  ADMIN
  OWNER
}

enum OrderStatus {
  PENDING // Order created, waiting payment
  PAID // Payment confirmed
  PROCESSING // Admin processing order
  SHIPPED // Order shipped
  DELIVERED // Order delivered
  COMPLETED // Order completed (after user confirmation or auto)
  CANCELLED // Order cancelled
  FAILED // Payment failed
}

enum PaymentMethod {
  MIDTRANS_SNAP // Midtrans Snap (all methods)
  PAYPAL // PayPal
  MANUAL // Manual transfer (for admin)
}

enum ShippingType {
  DOMESTIC // Biteship API (Indonesia)
  INTERNATIONAL // Manual zone-based
}

// ============================================
// USER & AUTH MODELS
// ============================================

model User {
  id          String  @id @default(uuid())
  firstName   String  @map("first_name") @db.VarChar(50)
  lastName    String  @map("last_name") @db.VarChar(50)
  username    String  @unique @db.VarChar(30)
  email       String  @unique @db.VarChar(255)
  password    String  @db.VarChar(255)
  phoneNumber String? @map("phone_number") @db.VarChar(20)

  country    String  @default("Indonesia") @db.VarChar(50)
  city       String? @db.VarChar(100)
  province   String? @db.VarChar(100)
  postalCode String? @map("postal_code") @db.VarChar(10)
  address    String? @db.VarChar(500)

  profileImage    String?   @map("profile_image") @db.VarChar(500)
  role            Role      @default(USER)
  isActive        Boolean   @default(true) @map("is_active")
  suspendedAt     DateTime? @map("suspended_at")
  suspendedReason String?   @map("suspended_reason") @db.Text
  lastLogin       DateTime? @map("last_login")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  refreshTokens     RefreshToken[]
  passwordResets    PasswordReset[]
  blacklistedTokens BlacklistedToken[]
  review            Review[]
  carts             Cart[]
  orders            Order[]

  @@index([email])
  @@index([username])
  @@index([role])
  @@index([isActive])
  @@index([deletedAt])
  @@index([country])
  @@index([postalCode])
  @@map("users")
}

// Model untuk menyimpan Refresh Token
model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique @db.VarChar(500)
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relation
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// Model untuk menyimpan token yang di-blacklist (logout)
model BlacklistedToken {
  id        String   @id @default(uuid())
  token     String   @unique @db.VarChar(500)
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relation
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([expiresAt])
  @@map("blacklisted_tokens")
}

// Model untuk Password Reset Token
model PasswordReset {
  id        String    @id @default(uuid())
  email     String    @db.VarChar(255)
  token     String    @unique @db.VarChar(500)
  userId    String    @map("user_id")
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  // Relation
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([token])
  @@index([expiresAt])
  @@map("password_resets")
}

// ============================================
// PRODUCT MODELS
// ============================================

// Model Product
model Product {
  id            String  @id @default(uuid())
  name          String
  slug          String  @unique // SEO-friendly URL
  idDescription String? @map("id_description") @db.Text
  enDescription String? @map("en_description") @db.Text
  idPrice       Int     @map("id_price")
  enPrice       Int     @map("en_price")

  // üìä Hybrid analytics fields
  totalSold Int    @default(0) @map("total_sold")
  totalView Int    @default(0) @map("total_view")
  avgRating Float? @default(0.0) @map("avg_rating")

  // üì¶ Informasi pengiriman (buat integrasi Biteship)
  weight Int? // gram
  height Int? // cm
  length Int? // cm
  width  Int? // cm

  // üí∞ Tax & Pricing
  taxRate Float? @default(0.0) @map("tax_rate") // e.g. 0.11 for 11% PPN

  // üîó Relationships
  categoryId String?   @map("category_id")
  category   Category? @relation(fields: [categoryId], references: [id])

  promotionId String?    @map("promotion_id")
  promotion   Promotion? @relation(fields: [promotionId], references: [id])

  tags       ProductTag[]
  reviews    Review[]
  variants   ProductVariant[]
  images     ProductImage[]
  gallery    GalleryImage[]
  cartItems  CartItem[]
  orderItems OrderItem[]

  // ‚öôÔ∏è Status & Features
  isActive     Boolean   @default(true) @map("is_active")
  isFeatured   Boolean   @default(false) @map("is_featured") // Show on homepage
  isPreOrder   Boolean   @default(false) @map("is_pre_order")
  preOrderDays Int?      @default(0) @map("pre_order_days") // Berapa hari pre-order
  deletedAt    DateTime? @map("deleted_at") // Soft delete

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([categoryId])
  @@index([promotionId])
  @@index([slug])
  @@index([isActive])
  @@index([isFeatured])
  @@index([deletedAt])
  @@map("products")
}

model ProductImage {
  id        String @id @default(uuid())
  productId String @map("product_id")
  imageUrl  String @map("image_url") @db.VarChar(500)
  order     Int    @default(0) // untuk urutan gambar (0 = primary)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([order])
  @@map("product_images")
}

model GalleryImage {
  id        String   @id @default(uuid())
  productId String
  imageUrl  String
  caption   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("gallery_images")
}

// Model ProductVariant
model ProductVariant {
  id          String @id @default(uuid())
  productId   String @map("product_id")
  variantName String @map("variant_name") // misal: "Black L", "White XL"
  sku         String @unique
  stock       Int    @default(0) @map("stock")

  product    Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  images     ProductVariantImage[]
  cartItems  CartItem[]
  orderItems OrderItem[] // ‚úÖ PHASE 2: Added

  // ‚öôÔ∏è Status
  isActive  Boolean   @default(true) @map("is_active")
  deletedAt DateTime? @map("deleted_at") // Soft delete

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([productId])
  @@index([sku])
  @@index([isActive])
  @@map("product_variants")
}

// Model ProductVariantImage
model ProductVariantImage {
  id        String @id @default(uuid())
  variantId String @map("variant_id")
  imageUrl  String @map("image_url")

  variant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([variantId])
  @@map("product_variant_images")
}

// Model Category
model Category {
  id        String    @id @default(uuid())
  name      String
  slug      String    @unique // SEO-friendly URL
  isActive  Boolean   @default(true) @map("is_active")
  products  Product[]
  deletedAt DateTime? @map("deleted_at") // Soft delete

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([slug])
  @@index([isActive])
  @@index([deletedAt])
  @@map("categories")
}

// Model Promotion
model Promotion {
  id        String    @id @default(uuid())
  name      String
  discount  Float // e.g. 0.15 for 15% off
  startDate DateTime  @map("start_date")
  endDate   DateTime  @map("end_date")
  isActive  Boolean   @default(true) @map("is_active")
  products  Product[]
  deletedAt DateTime? @map("deleted_at") // Soft delete

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([startDate, endDate])
  @@index([isActive])
  @@index([deletedAt])
  @@map("promotions")
}

// Model Tag
model Tag {
  id        String       @id @default(uuid())
  name      String       @unique
  slug      String       @unique // SEO-friendly URL
  isActive  Boolean      @default(true) @map("is_active")
  products  ProductTag[]
  deletedAt DateTime?    @map("deleted_at") // Soft delete

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([slug])
  @@index([isActive])
  @@index([deletedAt])
  @@map("tags")
}

// Junction Table: Product <-> Tag (Many-to-Many)
model ProductTag {
  productId String
  tagId     String

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([productId, tagId])
  @@index([productId])
  @@index([tagId])
  @@map("product_tags")
}

// Model Review
model Review {
  id        String        @id @default(uuid())
  userId    String        @map("user_id")
  productId String        @map("product_id")
  rating    Int           @default(0) // 1-5
  comment   String?       @db.Text
  images    ReviewImage[]

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([productId])
  @@index([userId])
  @@index([rating])
  @@map("reviews")
}

// Model ReviewImage
model ReviewImage {
  id       String @id @default(uuid())
  reviewId String @map("review_id")
  imageUrl String @map("image_url")

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@index([reviewId])
  @@map("review_images")
}

// ============================================
// CART MODELS
// ============================================

model Cart {
  id     String     @id @default(uuid())
  userId String     @unique @map("user_id")
  items  CartItem[]

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@map("carts")
}

model CartItem {
  id        String @id @default(uuid())
  cartId    String @map("cart_id")
  productId String @map("product_id")
  variantId String @map("variant_id")
  quantity  Int    @default(1)

  cart    Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([cartId, variantId]) // Prevent duplicate variants in same cart
  @@index([cartId])
  @@index([productId])
  @@index([variantId])
  @@map("cart_items")
}

// ============================================
// ‚úÖ PHASE 2: ORDER & SHIPPING MODELS
// ============================================

// Order Model
model Order {
  id          String @id @default(uuid())
  orderNumber String @unique @map("order_number") // ORD-YYYYMMDD-XXXX
  userId      String @map("user_id")

  // Order Status
  status OrderStatus @default(PENDING)

  // Pricing
  subtotal     Int // Total harga items sebelum discount
  discount     Int @default(0) // Discount dari promotion/voucher
  tax          Int // PPN 11%
  shippingCost Int @map("shipping_cost")
  total        Int // Grand total

  // Currency & Exchange Rate
  currency     String @default("IDR") // IDR atau USD
  exchangeRate Float? @map("exchange_rate") // Rate saat order dibuat (untuk USD)

  // Payment Info
  paymentMethod   PaymentMethod? @map("payment_method")
  paymentProvider String?        @map("payment_provider") // "midtrans", "paypal"
  paymentId       String?        @map("payment_id") // Transaction ID dari provider

  // Shipping Info
  shippingType   ShippingType @map("shipping_type")
  shippingMethod String       @map("shipping_method") // e.g., "JNE REG", "Zone 1"

  // Biteship fields (for domestic)
  biteshipCourier String? @map("biteship_courier") // "jne", "tiki", etc.
  biteshipService String? @map("biteship_service") // "reg", "yes", etc.
  biteshipOrderId String? @unique @map("biteship_order_id") // Biteship order ID
  trackingNumber  String? @unique @map("tracking_number") // AWB/tracking number

  // International shipping
  shippingZoneId String?       @map("shipping_zone_id")
  shippingZone   ShippingZone? @relation(fields: [shippingZoneId], references: [id])

  // Recipient Details
  recipientName      String  @map("recipient_name")
  recipientPhone     String  @map("recipient_phone")
  shippingAddress    String  @map("shipping_address")
  shippingCity       String  @map("shipping_city")
  shippingProvince   String? @map("shipping_province") // For domestic
  shippingCountry    String  @map("shipping_country")
  shippingPostalCode String  @map("shipping_postal_code")
  shippingNotes      String? @map("shipping_notes")

  // Timestamps
  paidAt      DateTime? @map("paid_at")
  shippedAt   DateTime? @map("shipped_at")
  deliveredAt DateTime? @map("delivered_at")
  completedAt DateTime? @map("completed_at")
  canceledAt  DateTime? @map("canceled_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  user  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  items OrderItem[]

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

// Order Item Model
model OrderItem {
  id        String @id @default(uuid())
  orderId   String @map("order_id")
  productId String @map("product_id")
  variantId String @map("variant_id")

  // Snapshot data (untuk history, case product/variant dihapus)
  productName  String @map("product_name")
  variantName  String @map("variant_name")
  sku          String
  quantity     Int
  pricePerItem Int    @map("price_per_item") // Harga per item saat order
  discount     Int    @default(0) // Discount per item dari promotion
  subtotal     Int // (pricePerItem - discount) * quantity

  // Image snapshot
  productImage String? @map("product_image")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  order   Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product        @relation(fields: [productId], references: [id])
  variant ProductVariant @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
  @@map("order_items")
}

// Shipping Zone Model (for international shipping)
model ShippingZone {
  id        String   @id @default(uuid())
  name      String   @unique // e.g., "Zone 1 - Asia", "Zone 2 - Europe"
  countries String[] // Array of country codes: ["SG", "MY", "TH"]

  // Pricing
  baseRate  Int @map("base_rate") // Base shipping fee
  perKgRate Int @map("per_kg_rate") // Additional per kg

  // Delivery estimate
  minDays Int @map("min_days")
  maxDays Int @map("max_days")

  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  orders Order[]

  @@map("shipping_zones")
}
