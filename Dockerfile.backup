# ---- STAGE 1: Build ----
FROM node:20-alpine AS builder
WORKDIR /usr/src/app

# Copy package files
COPY package*.json ./
COPY tsconfig*.json ./
COPY nest-cli.json ./

# Install dependencies
RUN npm ci

# Copy prisma schema first
COPY prisma ./prisma

# Generate Prisma Client
RUN npx prisma generate

# Copy source code
COPY src ./src

# Build the application
RUN npm run build

# Verify that main.js exists at the correct location
RUN echo "=== Verifying build output ===" && \
    ls -la dist/src/ && \
    if [ ! -f "dist/src/main.js" ]; then \
      echo "ERROR: dist/src/main.js not found after build!"; \
      exit 1; \
    fi && \
    echo "âœ… Build verification passed"

# ---- STAGE 2: Run ----
FROM node:20-alpine
WORKDIR /usr/src/app

# Install dumb-init for proper signal handling
RUN apk add --no-cache dumb-init

# Copy package files
COPY package*.json ./

# Install production dependencies only
RUN npm ci --only=production

# Copy prisma schema and generate client
COPY prisma ./prisma
RUN npx prisma generate

# Copy built application from builder stage (entire dist folder)
COPY --from=builder /usr/src/app/dist ./dist

# Create uploads directory
RUN mkdir -p /app/uploads

EXPOSE 3000

# Use dumb-init to handle signals properly
# PENTING: Gunakan dist/src/main.js
ENTRYPOINT ["dumb-init", "--"]
CMD ["sh", "-c", "npx prisma migrate deploy && node dist/src/main.js"]